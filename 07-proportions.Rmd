# Proportions and chi squared


This chapter looks at methods used for analyzing relationships in _categorical_ data. The variable of interest is not a single continuous variable (e.g. how income or weight varies between groups) but the relative _count_ or _proportion_ of observations that fall into each category.

A key point is that the chi-squared test used in these cases is equivanet to a test of nested Poisson regression models.

## Goodness of fit

A test of __goodness-of-fit__ establishes whether an observed frequency distribution differs from a theoretical distribution. For example, we could test the hypothesis that a random sample with 44 men and 56 women has been drawn from a population in which men and women are equal in frequency, i.e. with the theoretical distribution of 50 men and 50 women.

__Sample dataset:__

Assume we have one category (mood) with three possible levels ('happy', 'sad' or 'meh'). We have a sample of 120 observations in total, as generated by the code below. We also add dummy variables to represent 'happy' and 'sad' for use in the linear model.

```{r}
mydata_chi1 <- data.frame(mood = c("happy", "sad", "meh"),
               counts = c(60, 90, 70)) %>%

  # Dummy variables to be used in linear model
  mutate(mood_happy = if_else(mood == "happy", 1, 0)) %>%
  mutate(mood_sad = if_else(mood == "sad", 1, 0))
```

```{r, echo = FALSE}
knitr::kable(
  (mydata_chi1),
  caption = "Categorical data with one variable",
  booktabs = TRUE)
```

In this example, we may want to test whether the proportions of people with each mood in the underlying population are equal, based on our observation of 120 people.

__Chi-squared test:__

The goodness-of-fit test is based on the following test statistic:

::: {.center data-latex=""}

$\chi^2 = \sum \frac{(O_i - Ei)^2}{E_i}$

:::

where $O_i$ is the observed count in each category and $E_i$ is the expected count in each category.
The test statistic follows a chi-squared ($\chi^2$) distribution where the degrees of freedom are equal to the number of categories minus one, i.e. $d.f. = rows - 1$ (in this example, df = 2).

A worked example of a goodness-of-fit test is provided [in this video](https://www.khanacademy.org/math/statistics-probability/inference-categorical-data-chi-square-tests/chi-square-goodness-of-fit-tests/v/chi-square-statistic) by Khan Academy.

R's built-in chi-squared test, `chisq.test`, compares the proportion of counts in each category with the expected proportions. By default, the expected proportions in each category are assumed to be equal.

```{r}
#Built-in test
chisq.test(mydata_chi1$counts)
```

In this example, we would reject the null hypothesis that the proportion of people with each mood are all equal (p = 0.04151).

__Equivalent linear model:__

The equivalent linear model is a [Poisson regression](https://en.wikipedia.org/wiki/Poisson_regression). This is a type of Generalized Linear Model (GLM). Poisson regressions use the natural log of the dependent variable, and so are sometimes referred to as a _log-linear models_. The follow model specification can be used:

::: {.center data-latex=""}

$log(y) = \beta_0 + \beta_1 \cdot x_1 + \beta_2 \cdot x_2 + ...$

:::

where in this example $x_1$ and $x_2$ would be dummy variables representing 'happy' and 'sad' moods.

There are two reasons why we need to use a log-linear model rather than the OLS linear regression model, as explained in the book ['Broadening Your Statistical Horizons'](https://bookdown.org/roback/bookdown-bysh/) by Julie Legler and Paul Roback:

1. Since a Poisson random variable is a count, its minimum value is zero and, in theory, the maximum is unbounded. A line from an OLS is model certain to yield negative values for certain values of the dependent variable, $x$; however, $y$ can only take values from 0 to $\infty$.

2. The equal variance assumption in linear regression inference is violated, because as the expected value of a Poisson variable increases so too does the variance. With a Poisson distribution, the variance is equal to the expected value of the dependent variable, that is $E(Y) = VAR(Y)$.

These issues are addressed by taking the natural log of the dependent variable. It is assumed that the resulting logarithm of the dependent variable can be modeled by a linear combination of the independent variable(s) used in the model.

Because we are using the natural log of the dependent variable, the coefficients from our regression, $\beta_1$ and $\beta_1$, are interpreted as the _percentage_ differences in the number of people whose moods are happy or sad, relative to the reference level of 'meh'.^[Technically, the percentage difference is equal to $e^{\beta_1}$ and $e^{\beta_2}$, where $\beta_1$ and $\beta_2$ are continuously compounded rates of growth between 0 and 1. So for example, in the example below, the coefficient on 'sad' is $\beta_2 = 0.2513$. This mean the proportion of people in the 'sad' category are higher by $e^{0.2513} - 1 = 0.286 = 28.6\%$ than the proportion of people in the 'meh' category. This is equal to difference of the count of people in these two categories i.e. 90 'sad' people and 70 'meh' people.] Because of this, it can be used as a test for differences of proportions; that is, whether there is a significant difference in the percentage of people in each category.

To assess whether the differences between categories (moods) are statistically significant we compare two nested models, just as we did with the ANOVA and ANCOVA tests in the previous chapter. In this case we compare a 'full' Poisson regression model, which includes our dummy variables, and a 'null' model which does not. Instead of using the F-test to compare nested models (as was the case with ANOVA/ANCOVA), here we use a ['score test'](https://en.wikipedia.org/wiki/Score_test), specifically the Rao test. This gives us a test statistic that follows a $\chi^2$ distribution, with the degrees of freedom being equal to the additional parameters in the full model compared to the null model.

The code is as follows:

```{r}
full <- glm(counts ~ 1 + mood_happy + mood_sad,
            data = mydata_chi1,
            family = poisson())
null <- glm(counts ~ 1,  data = mydata_chi1, family = poisson())
anova(null, full, test = "Rao")

```

__Comparison:__

As seen above, the p-value is identical under both the built-in chi-squared test and the equivalent linear model:

```{r, echo = FALSE}
knitr::kable(
  tribble(
    ~model, ~"Chi-squared", ~"df", ~p.value,
    "chisq.test", 6.3636, 2, 0.04151,
    "glm", 6.3636, 2, 0.04151
    ),
  caption = "Goodness-of-fit: chi-squared test and equivalent linear model",
  booktabs = TRUE
)
```

## Contingency tables

Contingency tables are used in statistics to summarize the relationship between two categorical variables. They are used to test whether the frequency distribution differs between two or more groups. This can be tested using R"s built-in chi-squared test (`chisq.test`), similar to the goodness-of-fit test above, or again as two nested linear models (Poisson regressions), one of which includes dummy variables representing the interaction between the two categories in our table.

__Sample dataset:__

As an example, we might like to test whether a subjects mood (happy, sad or meh) is related to sex (male or female). We can create the following data set:

```{r}
mydata_chi2 <- data.frame(
  sex = c("male", "female"),
  happy = c(70, 100),
  meh = c(32, 30),
  sad = c(120, 110)
)
```

```{r, echo = FALSE}
knitr::kable(
  (mydata_chi2),
  caption = "A contingency table",
  booktabs = TRUE)
```


__Chi-squared test:__

As shown above, a contingency table is a table that lists the frequencies of occurrence for categories of __two__ variables. The first variable is shown in rows, and the second variable is shown in columns.

Contingency tables can be used to assess whether the proportion of observations in one category depends on, or is _contingent_ upon, the other category in the table. There are actually two types of tests:

* A test of __homogeneity__. This tests the null hypothesis that _different populations_ have the same proportions of some characteristics. The key difference from the test of independence is that there are multiple populations that the data is drawn from. The null hypothesis is that the proportion of X is the same in all populations studied.
* A test of __independence__. A test of independence tests the null hypothesis that there is no association between the two variables in a contingency table where the data is all drawn from _one population_. The null hypothesis is that X and Y are independent.

Both these tests involve the exactly the same mathematical procedures and only differ only in terms of the hypothesis being tested. Some further reading can be found [here](http://www.u.arizona.edu/~kuchi/Courses/MAT167/Files/LH_LEC.0640.HypTest.IndepHomog.pdf).

These tests are based on a similar test statistic to the goodness-of-fit test:

::: {.center data-latex=""}

$\chi^2 = \sum \frac{(O_i - Ei)^2}{E_i}$

:::

where $O_i$ is the observed count in each category and $E_i$ is the expected count in each category.
The test statistic follows a chi-squared ($\chi^2$) distribution where the degrees of freedom are found by $d.f. = (rows - 1)(columns - 1 )$.

A worked example of a chi-squared test is provided [in this video](https://www.khanacademy.org/math/statistics-probability/inference-categorical-data-chi-square-tests/chi-square-tests-for-homogeneity-and-association-independence/v/chi-square-test-homogeneity) by Khan Academy.

Râ€™s built-in chi squared test, `chisq.test`, can be used to assess whether the distribution of observations in one category is contingent on the distribution of observations under the other category. Note that first we must convert our data to a matrix and drop the first column (in this case  `sex`):

```{r}
# Convert data to matrix format, need for the built-in chi-squared
mydata_chi2_matrix <- mydata_chi2 %>%
  select(-sex) %>%
  as.matrix()
```

Now carry out the chi-squared test:
```{r}
# Built-in chi-squared
chisq.test(mydata_chi2_matrix)
```

Based on this p-value we would not reject the null hypothesis that sex and mood were independent at the 0.05 level of significance.

__Equivalent linear model:__

The equivalent linear model is a Poisson regression with interaction terms between the two sets of dummy variables (in this case one set of dummy variables is for mood, the other is for sex).

Here we are testing for the interaction between two the two categories, just as we did with the two-way ANOVA (though here our dependent variable is the natural log of the count of observations, rather than the value of a single continuous variable). The test is equivalent to the following linear model, which is expressed using matrix notation:

::: {.center data-latex=""}

$log(y) = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_2  X_3 \qquad  H_0: \beta_3 = 0$

:::

Here $X_1$ and $X_2$ represent the two categories in our model (in this example, mood and sex). $\beta_3$ is a vector that relates to the interactions of the categories. Here, it will be a vector comprising two values, corresponding to the combinations of the sex and mood dummy variables (`male` and `mood_happy`, and `male` and `mood__meh`). The null hypothesis (of $\beta_3 = 0$) is that all values in this vector are zero, and that there is no interaction between sex and mood when explaining the distribution of observations in each category.

We begin by expressing our data in 'long' format, including dummy variables to identify the groups of people who are happy and 'meh'. This following data will be used in our linear model:

```{r, echo = FALSE}
mydata_chi2_long <- mydata_chi2 %>%
  gather(mood, Freq, happy:sad) %>%
  # Create dummy variables for mood and sex
  mutate(mood_happy = if_else(mood == "happy", 1, 0)) %>%
  mutate(mood_meh = if_else(mood == "meh", 1, 0)) %>%
  mutate(sex_male = if_else(sex == "male", 1, 0))
```

```{r, echo = FALSE}
knitr::kable(
  (mydata_chi2_long),
  caption = "Contingency table data in long format with dummy variables",
  booktabs = TRUE)
```

The test involves a comparison of two nested linear models: a full model which includes the interaction terms between the two sets of dummy variables, and the null model which excludes the interaction terms. Again we use the (Rao) score test.

```{r}
full <- glm(Freq ~ 1 + mood_happy + mood_meh + sex_male +
                   mood_happy*sex_male + mood_meh*sex_male,
            data = mydata_chi2_long, family = poisson())
null <- glm(Freq ~ 1 + mood_happy + mood_meh + sex_male,
            data = mydata_chi2_long, family = poisson())
anova(null, full, test = "Rao")
```

Note that the only difference between the nested models is the two interaction terms. Intuitively, we are testing whether the _interaction_ of the two categories is statistically significant, i.e. whether the interaction between mood and sex can explain the distribution of observations over and above the individual effects of mood and sex alone.

__Comparison:__

As summarized in the table below, the linear model gives the same test statistic as the built-in chi-squared test, has the same degrees of freedom (which is equal to the number of interaction terms), and the same p-value.

```{r, echo = FALSE}
knitr::kable(
  tribble(
    ~model, ~"Chi-squared", ~"df", ~p.value,
    "chisq.test", 5.0999, 2, 0.07809,
    "glm", 5.0999, 2, 0.07809
    ),
  caption = "Contingency table: chi-squared test and linear model",
  booktabs = TRUE
)
```